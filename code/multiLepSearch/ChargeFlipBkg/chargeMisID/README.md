# README: ChargeMisID 
Last update: 7 September 2016

*Note: The current recommendation is to use the code based on EGamma's, which is in the chargeMisID/EG directory.*

Part of the [ChargeFlipBkg](../) code package developed by Gabriel Gallardo for the UM/HK EWK SUSY SS 2L analysis. 

- [Credits](#credits)
- [ChargeMisID.C](#chargemisidc)
    + [Execution](#execution)
    + [Configurable options](#configurable-options)
    + [Using the opt argument](#using-the-opt-argument)
- [CompareDataMC.C](#comparedatamcc)
    + [Execution](#execution-1)
    + [Configurable options](#configurable-options-1)
- [draw.sh](#drawsh)
    + [Execution](#exectuion-2)

## Credits ##
chargeMisID.C: 
- written by Gabriel Gallardo Jun 2015 - Jul 2016
- with contribution by YatLong Chan Nov 2015 for implementation of likelihood method

compareDataMC.C:
- written by Gabriel Gallardo Feb - Jul 2016

draw.sh
- written by Gabriel Gallardo Mar - Apr 2016

## ChargeMisID.C ##
chargeMisID.C was written to calculate electron charge misID from UM/HKU SUSY NTuples for Run 2. The chargeMisId rates are measured by 
- likelihood method
- tag-and-probe method
- extraction of MC truth (on MC samples)

Input: UM/HKU SUSY NTuples for Run 2  
Output: 
- In output.root: 2D histograms of chargeMisID rates over eta and pt 
    + hFlipProb: MisID rates as measured by the likelihood method
    + hTPFlip: MisID rates as measured by the tag-and-probe method
    + hMCFlip: MisID rates as measured by truth information
- In checks.root: Cut flow histograms
    + hCutflow: Number of events passing each cut
    + Distributions of m_{ee}, eta, pt, phi at different steps of the cut flow

The script runs using the class generated by `evt2l->MakeClass()`.

### Execution ###
`root -l -b -q "chargeMisID.C(\"outputDir\", \"inFileList.txt\", \"opt\")"`
OR
`root -l -b -q "chargeMisID.C+(\"outputDir\", \"inFileList.txt\", \"opt\")"`

- `outputDir` is the directory to which the output files (PDFs, .root files) will be saved. If it does not exist, it will be created. Any files with the same name as the files created by the script will be overwritten.
- `inputFileList.txt` is a list of the NTuples to be examined. List the full path to each file on a separate line.
- `opt` configure options. (Optional argument.) See the section "[Using the opt argument](#using-the-opt-argument)". 

### Configurable options ###
All configuration options are available in the #CONFIG VARIABLES# section at the top of the script. 

**Choosing to run on MC or data** (*Configurable from opt*)  
Set variable `isMC` to `true` for MC; set to `false` for data.  

**Choosing signal or LooseBaseline electrons**  (*Configurable from opt*)  
Set variable `onlySignal` to `true` for signal electrons; set to `false` for LooseBaseline.

All electrons saved should be LooseBaseline electrons.  
Signal electrons are selected by checking if the flag `evt2lTree.leps_lFlag[i] & 2)/2` is true.

(For 20.1 derivation, the flags to check for LooseBaseline/Signal were `evt2lTree.leps_lFlag[0] & 1<<0` and `evt2lTree.leps_lFlag[i] & 1<<1` respectively.)

**Print decay tree of MC truth particle**
- Set variable `debugMC` to `true` to print, `false` otherwise.  
- `false` is the recommended setting. The output text file can be of size O(100MB).

**Measure misID rates as a function of truth pt**
- Set variable `MCtruthPt` to `true` to do so, `false` otherwise.  

**Apply pile up reweighting**
- Set `applyPRW` to `true` to apply, `false` otherwise.  

**Output options**
- Set `print` to true to output to PDF; `false` otherwise (recommended set to true)
- Set `toFile` to `true` to output to .root file; `false` otherwise (recommended set to true)
- Set `drawEta`, `drawPt`, `drawEtaPt`, `drawPtEta` to draw the corresponding histograms; `false` otherwise
- `drawEta` and `drawPt` options not recommended. Plots returned by the corresponding functions do not accurately represent the rates.

**Binning in eta and pt**  
Assign the arrays of eta and pt bin edges to `*EtaEdges` and `*PtEdges` respectively. The number of bins must be manually specified in `nEtaBins` and `nPtBins`.

**Event selection and sideband width** (*Configurable from opt*)  
- Set `Z_MASS_LOWER_LIMIT` and `Z_MASS_UPPER_LIMIT` for Z mass window
    + Recommended range: (80,100). This is (mZÂ±10)
- Set `SIDEBAND_L` and `SIDEBAND_R` for sideband size. Recommended sideband size is 20 GeV

**Tag and probe conditions**
- Set `doTP` to `true` if you want to do tag-and-probe; `false` otherwise
- Set `etaCut`, `ptCut`, `d0sigCut`, `BHitsCut`, `SiHitsCut` for conditions of tag electron. Currently optimized to:
    + eta < 1.37
    + ptCut > 20 GeV
    + |d0/d0sig| < 1.5
    + nBHits >= 1
    + nSiHits >= 9


### Using the opt Argument ###
The `opt` argument was introduced for easy scripting. An example of the syntax is:

`"ml=75,mr=100,sb=25,el=l,mc=y"`

Every option is two letters with an '=' character, options are separated by a ',' character. The options available are:

**Z Mass limit**
- `ml=` Lower Z-mass limit. Accepts two character integer.
- `mr=` Upper Z-mass limit. Accepts three character integer. If only two characters, it much be written as `095`.

**Sideband size**
- `sb=` Sideband size (on both sides). Accepts two character integer.
- `sr=` Upper sideband size. Accepts two character integer.
- `sl=` Lower sideband size. Accepts two character integer.
- `sb=xx` is equivalent to `sr=xx,sl=xx`

**Object definition**
- `el=` Object selection. Option `l` for looseBaseline, option `s` for signal.

**MC or data**
- `mc=` Whether input is MC. Option `y` for MC, option `n` for data.

**Other**
- `mx=` Max number of entries. Accepts three character integer. Set only for debugging.

## compareDataMC.C ###
compareDataMC.C was written to compare the rates of chargeMisID obtained by MC truth and likelihood method on data and MC.

### Execution ###
`root -l -b -q "compareDataMC.C(\"dataNoSub.root\", \"dataSubbed.root\", \"MC.root\", \"outputDir\")"`

- `dataNoSub.root` is the root file with no sideband subtraction
- `dataSubbed.root` is the root file with sideband subtraction
- `MC.root` is the root file from MC (no subtraction, of course)
- `outputDir` is the directory to which the output PDFs and .root file will be saved
    + Default is "."

*Recommendation:* Run in batch mode! Otherwise a lot of histograms will pop out at once. Suggest to print to PDF, then open the plots in a PDF viewer.

*Note:* In fact this script can be used to compare rates from any file. Simply:
- Specify the filename in the arguments
- Set the corresponding bool values at the top of the script:
    + `drawData`, `drawSub`, `drawMC`, `drawMCLH`, `drawCompare`
- Set the relevant bin labels:
    + `sData`, `sDataSubbed`, `sMC`, `sMCLH`, `sCompare`
- Comment in/out (and modify the histogram name in) the relevant lines in compareDataMC() at the bottom of the file
- *N.B.* the `drawCompare` option will draw 
    + "data"/"MC" if no "sub" histograms is provided
    + both "data"/"MC" and "sub"/"MC" otherwise
    + Set the `sCompare` string to reflect what is being divided by what

**Output:**  
Main output are PDFs of the rates. The rates compared are data (likelihood, no subtraction), data (likelihood, with subtraction), MC (likelihood), and MC (truth).

### Configurable options ###
In draw() at the top of the script, set `drawEtaPt`, `drawPtEta`, `drawPt`, `drawEta` to draw the corresponding plots.  

Set `print` to true to output to PDF; false otherwise.  
Set `toFile` to output the histograms to a .root file; false otherwise.
Set `drawLegend` to true to draw the colors and dots in the legend; false otherwise. Useful for drawing plots for presentations where the legend can be unified on the slide instead of on each plot.c

## draw.sh ##
Written to automate the drawing of plots for different conditions. 
Configurable options:
- Run label: `today`
- Z mass limits: `ml`, `mr`
- Sideband sizes: `sl`, `sr`

Outputs to terminal and `log.txt`

### Execution ###
`./draw.sh`
Double check the options and enter `y` to confirm. Any other character to cancel execution.
