# README: ChargeFlipBkg 
Last update: 28 Jul 2016

Part of the [ChargeFlipBkg](../) code package developed by Gabriel Gallardo for the UM/HK EWK SUSY SS 2L analysis.

All code in this sub-package is developed by Gabriel Gallardo, Jul 2016.

## Contents
As stated in the [workflow section](../README.md#the-workflow) of the [package documentation](../README.md), there are two ways to use the misID rates and pt corrections derived by the [chargeMisID](../chargeMisID/EG/) and [ptCorr](../ptcorr/) sub-packages. 

**Option 1:** Save to an NTuple and read this NTuples in parallel to the original NTuples  
- [saveSSprediction.C](#savesspredictionc)
  + [Execution](#execution)
  + [Configuration](#configuration)
  + [How the variables are saved](#how-the-variables-are-saved)
- [extractSSprediction.C](#extractsspredictionc)
  + [Execution](#execution-1)
  + [Configuration](#configuration-1)
  + [Adding new histograms](#adding-new-histograms)

**Option 2:** Direct to histograms from histograms and original NTuples  
- [getSSPrediction.C](#getsspredictionc)
  + [Configuration](#configuration-2)
  + [Execution](#execution-2)

**Other (deprecated) scripts in this sub-package**
- etaSF/matchEtaShape.C: An attempt to correct the shape of the eta distribution by obtaining scale factors. Not satisfactory. 
- mllWeighting/getMllWeights.cpp: An attempt to correct the distributions by normalizing to the mll or leading pt distribution. Superseded by the ptCorr sub-package.

## saveSSprediction.C
- Saves chargeMisID rates, pt corrections, and associated statistical errors to a TTree

### Execution
`root -l -b -q "saveSSprediction+(\"outputDir\", \"inFileList.txt\", \"ratesFile.root\", \"dPtfile.root\", \"opt\")"`
- `outputDir`: Name of output directory. If it doesn't exists, the program will attempt to create it
- `inFileList.txt`: Path to list of UM/HK SUSY NTuples
- `ratesFile.root`: Path to root file containing misID rates histogram
- `dPtfile.root`: Path to root file containing dPt histogram
- `opt`: Options argument. Currently only option is:
  + `"el=l"` selects LooseBaseline pairs, `"el=s"` selects Signal pairs

### Configuration
- `defaultRatesHistogram`: Name of misID rates histogram in the associated root file
  + x-axis: |eta|, y-axis: pt
- `defaultDPtHistogram`: Name of pt correction histogram in the associated root file
  + x-axis: pt, y-axis: |eta|

The script can be run without specifying arguments if these configuration variables are correctly set:
- `defaultOut`
- `defaultNTupleList`
- `defaultRatesFile`
- `defaultDPtFile`
- `defaultRatesHistogram`
- `defaultDPtHistogram`
- `onlySignal`

### How the variables are saved
The TTree is defined by the `struct` `vars`:
```c++
struct vars{
   double chargeFlipWeight;

   double e1rate;
   double e1rateErr;
   double e2rate;
   double e2rateErr;
   
   double e1dPt;
   double e1dPtErr;
   double e2dPt;
   double e2dPtErr;
};
```

The misID rates, pt corrections are extracted from histograms based on the electron's |eta| and pt.

`chargeFlipWeight` is calculated by:  
```c++
double pss = e1rate + e2rate - 2*(e1rate)*e2rate) = e1rate*(1-e2rate) + (1-e1rate)*e2rate
chargeFlipWeight = pss / (1-pss)
```

Events must pass these cuts in order for the variables to be saved:
- At least one trigger
- Exactly two leptons
- Both leptons are electrons *//Should change this requirement to save for electrons only*
- Pass Signal (if `onlySignal` is `true`)

If the cuts are not passed, then all the variables are set to -1.

## extractSSprediction.C
Loops over UM/HK SUSY NTuples and their associated tree of misID variables (which was generated by `saveSSprediction.C`) to produce histograms

### Execution
`root -l - b -q "extractSSprediction.C+(\"outputDir\", \"inFileList.txt\", \"misIDdecorations.root\", \"opt\")"`
- `outputDir`: Path to output directory. The script will attempt to create it if it doesn't exists
- `misIDdecorations.root`: Path to file generated by `saveSSprediction.C`
- `opt`: Options argument. Currently only option is:
  + `"el=l"` selects LooseBaseline pairs, `"el=s"` selects Signal pairs

### Configuration
- `onlySignal`: Set to `true` for Signal pairs, `false` for LooseBaseline. Overridden by `opt`
- `applyPtCorrection`:  Set to `true` to apply PtCorrection

The script can be run without arguments if these variables are set correctly:
- `defaultOut`: Path to output directory. The script will attempt to create it if it doesn't exists
- `defaultNTupleList`: Path to list of UM/HK SUSY NTuples
- `defaultMisIdfile`: Path to NTuples of misID decorations generated by `saveSSprediction.C`

### Adding new histograms
This script makes use of the class `Histos`, which conveniently encapsulates all three histograms (SS, OS, expected SS) for each variable and their associated histogram operations (fill, draw, and write). This makes it easy to create histograms for new variables, and to remove unnecessary histograms.

```c++
class Histos
{
  protected:
   Histos(){ SS = ExpSS = OS = Ratio = 0;}
  public:
   TString name;
   TH1D* SS;
   TH1D* ExpSS;
   TH1D* OS;
   TH1D* Ratio;
   TCanvas* c;
   TLegend* l;

   // Initializes the object, including bin setting for the histograms
   Histos(TString name, TString title, TString xLabel, TString yLabel int nBins, double xMin, double xMax);
   ~Histos();

   void Fill(double value, bool SSevent); // Fill the histograms
   void Draw();                           // Draw SS, ExpSS and ExpSS/SS
   void DrawOS();                         // Draw OS
   void Write();                          // Write to file

   // Set legend coordinates with arguments given to a TLegend constructor
   void SetLegendXY(double x1, double y1, double x2, double y2)
};
```

To add a new set of histograms, simply:
1. Define a new instance of the class before the `for` loop in the `extractSSprediction()` function
2. Add another line to fill the histogram within the `for` loop. 
3. There is no step 3! The histograms are automatically drawn to PDF and written to file in the second `for` loop.

## getSSPrediction.C
getSSPrediction.C can do everything the previous two scripts can. The major difference is that *no intermediate NTuple is required.* It makes use of the [ChargeFlipTool](../ChargeFlipTool) in this package (not to be confused with the `ChargeFlipBkgTool` one in the `multiLepSearch` package, though they have similar functions.)

### Execution
`root -l -b -q "getSSPrediction.C(\"outDir\", \"inFileList.txt\", \"misIDfile.root\", \"dPtfile.root\", \"opt\")"`
- `outDir`: Path to output directory. The script will attempt to create it if it doesn't exist
- `inFileList.txt`: File list of UM/HK SUSY NTuples 
- `misIDfile.root`: Path to misID file
- `dPtfile.root`: Path to dPt file
- `evts`: Set to `"el=l"` or `"el=s"`, same as above

### Configuration
This script makes use of `ChargeFlipTool`. Set the relevant [readme.md](../ChargeFlipTool/README.md)

- `applyPtCorrection`: Set whether to apply pT correction